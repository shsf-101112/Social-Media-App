{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">

    <!-- Left Sidebar -->
    <div class="col-md-3 d-none d-md-block">
      <div class="card mb-4">
        <div class="card-header fw-bold">Navigation</div>
        <div class="card-body">
          <a href="{% url 'feed' %}" class="btn btn-outline-primary w-100">← Back to Feed</a>
        </div>
      </div>
    </div>

    <!-- Center: Profile & Posts -->
    <div class="col-md-6 mx-auto">
      <div class="card text-center mb-4">
        {% if profile.profile_picture %}
          <img src="{{ profile.profile_picture.url }}" class="card-img-top object-fit-cover p-3 rounded mx-auto" style="aspect-ratio: 1 / 1; width: 200px;" alt="Profile picture">
        {% else %}
          <img src="{% static 'default_profile.png' %}" class="card-img-top object-fit-cover p-3 rounded mx-auto" style="aspect-ratio: 1 / 1; width: 200px;" alt="Default picture">
        {% endif %}
        <div class="card-body">
          <h5 class="fw-bold">{{ profile.user.username }}</h5>
          <p class="text-muted">{{ profile.user.email }}</p>

          {% if user == profile.user %}
          <form method="POST" enctype="multipart/form-data" id="profile-pic-form">
            {% csrf_token %}
            <div class="input-group mb-2">
              <input type="file" name="profile_picture" class="form-control" accept="image/*" required>
              <button class="btn btn-sm btn-primary" type="submit">Update Profile Picture</button>
            </div>
          </form>
          {% endif %}
        </div>
      </div>

      <!-- User Posts -->
      <h5 class="mb-3">{{ profile.user.username }}'s Posts</h5>
      {% for post in posts %}
        <div class="card mb-4 shadow-sm">
          {% if post.image %}
            <img src="{{ post.image.url }}" class="card-img-top" style="aspect-ratio: 1 / 1; object-fit: cover;">
          {% elif post.video %}
            <video class="card-img-top" controls style="aspect-ratio: 1 / 1; object-fit: cover;">
              <source src="{{ post.video.url }}" type="video/mp4">
            </video>
          {% endif %}

          <div class="card-body text-start">
            {% if post.content %}
              <p class="card-text mb-1">{{ post.content }}</p>
            {% endif %}
            <small class="text-muted">{{ post.created_at|date:"F j, Y, g:i a" }}</small>

            <!-- Like -->
            <button class="btn btn-outline-danger btn-sm mt-2 like-btn" data-post-id="{{ post.id }}">
              ❤️ Like (<span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>)
            </button>

            <!-- Comment Form -->
            <form class="comment-form mt-2" data-post-id="{{ post.id }}">
              {% csrf_token %}
              <div class="input-group">
                <input type="text" name="comment" class="form-control form-control-sm comment-input" placeholder="Add a comment..." required>
                <button class="btn btn-outline-secondary btn-sm" type="submit">Post</button>
              </div>
            </form>

            <!-- Comments -->
            <div class="comments mt-2" id="comments-{{ post.id }}">
              {% for comment in post.comment_set.all %}
                <p class="mb-1"><strong>{{ comment.user.username }}</strong>: {{ comment.text }}</p>
              {% endfor %}
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted text-center">No posts yet.</p>
      {% endfor %}
    </div>

    <!-- Right Sidebar -->
    <div class="col-md-3 d-none d-md-block"></div>
  </div>
</div>

<!-- AJAX Scripts -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Profile Picture Upload (Live Reload)
  const profileForm = document.getElementById('profile-pic-form');
  if (profileForm) {
    profileForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(profileForm);
      const response = await fetch("{% url 'update_profile_pic' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
      });
      if (response.ok) {
        location.reload();  // Refresh to show updated picture
      }
    });
  }

  // Like Button
  document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', async e => {
      e.preventDefault();
      const postId = button.dataset.postId;
      const res = await fetch(`/like/ajax/${postId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      if (res.ok) {
        const data = await res.json();
        document.getElementById(`like-count-${postId}`).textContent = data.total_likes;
      }
    });
  });

  // Comment Form
  document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const postId = form.dataset.postId;
      const input = form.querySelector('.comment-input');
      const comment = input.value.trim();
      if (!comment) return;
      const res = await fetch(`/comment/ajax/${postId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ text: comment })
      });
      if (res.ok) {
        const data = await res.json();
        const commentHTML = `<p class="mb-1"><strong>${data.username}</strong>: ${data.text}</p>`;
        document.getElementById(`comments-${postId}`).insertAdjacentHTML('beforeend', commentHTML);
        input.value = '';
      }
    });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}

