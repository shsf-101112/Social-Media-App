{% extends 'base.html' %}
{% load static %}

{% block title %}Collab Radar - Tints&Trends{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<!-- Make sure jQuery is loaded first (required by Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Then load Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM fully loaded - JavaScript is running');
  
  // Initialize Select2 for the filters
  try {
    jQuery('#skillsFilter').select2({
      theme: 'bootstrap-5',
      width: '100%',
      placeholder: 'Select skills...',
      allowClear: true
    });
    
    jQuery('#interestsFilter').select2({
      theme: 'bootstrap-5',
      width: '100%',
      placeholder: 'Select interests...',
      allowClear: true
    });
    console.log('Select2 initialized successfully');
  } catch (e) {
    console.error('Error initializing Select2:', e);
  }

  // Set up all event handlers
  setupFilters();
  setupSaveAvailability();
  setupStartScan();
  
  // Apply initial filters
  setTimeout(applyFilters, 500);
});

// Function to set up filters
function setupFilters() {
  console.log('Setting up filters');
  
  const filters = ['skillsFilter', 'interestsFilter', 'availabilityFilter'];
  filters.forEach(filterId => {
    const element = document.getElementById(filterId);
    if (element) {
      element.addEventListener('change', applyFilters);
    }
  });
}

// Function to apply filters
function applyFilters() {
  console.log('Applying filters');
  
  // Get filter values
  const selectedSkills = jQuery('#skillsFilter').val() || [];
  const selectedInterests = jQuery('#interestsFilter').val() || [];
  const minAvailabilityHours = parseInt(document.getElementById('availabilityFilter')?.value || '0');
  
  console.log('Filter criteria:', {
    skills: selectedSkills,
    interests: selectedInterests,
    minHours: minAvailabilityHours
  });
  
  // Filter users in the radar
  filterUsers(selectedSkills, selectedInterests, minAvailabilityHours);
}

// Function to filter users based on criteria
function filterUsers(skills, interests, minHours) {
  // Get all user dots
  const userDots = document.querySelectorAll('#userDots .user-dot');
  let visibleCount = 0;
  
  userDots.forEach(dot => {
    // Get user data from data attributes
    const userSkills = getDataArray(dot, 'skills');
    const userInterests = getDataArray(dot, 'interests');
    const userHours = parseInt(dot.dataset.hours || '0');
    
    let showUser = true;
    
    // Apply filters
    if (minHours > 0 && userHours < minHours) {
      showUser = false;
    }
    
    if (skills.length > 0 && !userSkills.some(skill => skills.includes(skill.toString()))) {
      showUser = false;
    }
    
    if (interests.length > 0 && !userInterests.some(interest => interests.includes(interest.toString()))) {
      showUser = false;
    }
    
    // Show or hide based on filter results
    dot.classList.toggle('d-none', !showUser);
    if (showUser) visibleCount++;
  });
  
  console.log(`Filter applied: ${visibleCount} users visible out of ${userDots.length}`);
  updateMatchesContainer();
}

// Helper function to parse JSON data attributes safely
function getDataArray(element, attributeName) {
  try {
    return JSON.parse(element.dataset[attributeName] || '[]');
  } catch (e) {
    console.warn(`Error parsing data-${attributeName}:`, e);
    return [];
  }
}

// Function to update matches container based on visible dots
// Improved function to update matches container based on visible dots
function updateMatchesContainer() {
  const matchesContainer = document.getElementById('matchesContainer');
  if (!matchesContainer) {
    console.error('Matches container not found');
    return;
  }
  
  // Check for user dots in SVG
  const visibleUsers = document.querySelectorAll('#userDots .user-dot');
  
  if (visibleUsers.length === 0) {
    matchesContainer.innerHTML = '<div class="col-12 text-center text-muted"><p>No matching collaborators found</p></div>';
    return;
  }
  
  // Clear container and add user cards
  matchesContainer.innerHTML = '';
  
  // Create an array to hold user data from dots
  const users = [];
  
  visibleUsers.forEach(dot => {
    // Extract user data from dot attributes
    const user = {
      id: dot.dataset.userId,
      username: dot.dataset.userName,
      profile_pic: dot.dataset.userImage || '/static/images/default-profile.png',
      skills: dot.dataset.skills ? JSON.parse(dot.dataset.skills) : [],
      interests: dot.dataset.interests ? JSON.parse(dot.dataset.interests) : [],
      availability_hours: dot.dataset.hours || '0'
    };
    
    users.push(user);
  });
  
  // Now display cards for all users
  displayMatchCards(users, matchesContainer);
}

// Function to set up save availability form
function setupSaveAvailability() {
  console.log('Setting up save availability button');
  
  const availabilityForm = document.querySelector('form');
  const saveAvailabilityBtn = document.getElementById('saveAvailability') || 
                             document.querySelector('button[type="submit"]') ||
                             document.querySelector('button:contains("Save Availability")');
  
  if (availabilityForm) {
    availabilityForm.addEventListener('submit', function(e) {
      e.preventDefault();
      saveAvailability();
    });
  }
  
  if (saveAvailabilityBtn && !saveAvailabilityBtn.getAttribute('data-handler-attached')) {
    saveAvailabilityBtn.setAttribute('data-handler-attached', 'true');
    saveAvailabilityBtn.addEventListener('click', function(e) {
      e.preventDefault();
      saveAvailability();
    });
  }
}

// Function to get CSRF token
function getCsrfToken() {
  // Look for CSRF token in meta tag
  const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
  if (csrfTokenMeta) {
    return csrfTokenMeta.getAttribute('content');
  }
  
  // Look for CSRF token in cookie
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'csrftoken') {
      return value;
    }
  }
  
  // Look for token in hidden input (Django's typical approach)
  const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
  if (csrfInput) {
    return csrfInput.value;
  }
  
  return null;
}

// Function to handle saving availability
function saveAvailability() {
  console.log('Executing save availability function');
  
  // Find form elements more reliably
  const availableToggle = document.getElementById('availableToggle') || 
                         document.querySelector('input[type="checkbox"][name*="available"]');
                         
  const availabilityHours = document.getElementById('availabilityHours') || 
                           document.querySelector('select[name*="hours"], input[name*="hours"]');
                           
  const availabilityNotes = document.getElementById('availabilityNotes') || 
                           document.querySelector('textarea[name*="notes"]');
  
  if (!availableToggle || !availabilityHours) {
    console.error('Could not find necessary form elements');
    alert('Error: Could not find form elements. Please check the HTML structure.');
    return;
  }
  
  // Get values
  const isAvailable = availableToggle.checked;
  const hours = availabilityHours.value || '0';
  const notes = availabilityNotes ? availabilityNotes.value : '';
  
  console.log('Form values:', { isAvailable, hours, notes });
  
  // Get save button for visual feedback
  const saveAvailabilityBtn = document.getElementById('saveAvailability') || 
                             document.querySelector('button[type="submit"]');
  
  // Show loading state
  let originalText = '';
  if (saveAvailabilityBtn) {
    originalText = saveAvailabilityBtn.innerHTML;
    saveAvailabilityBtn.disabled = true;
    saveAvailabilityBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
  }
  
  // Get CSRF token
  const csrfToken = getCsrfToken();
  if (!csrfToken) {
    console.error('CSRF token not found');
    alert('Error: CSRF token not found. Please refresh the page.');
    
    // Reset button
    if (saveAvailabilityBtn) {
      saveAvailabilityBtn.disabled = false;
      saveAvailabilityBtn.innerHTML = originalText;
    }
    
    return;
  }
  
  // Send request to save availability
  fetch('/profile/availability/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      available: isAvailable.toString(),
      hours: hours.toString(),
      notes: notes
    })
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => {
        throw new Error(`Server error (${response.status}): ${text}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    showAvailabilityMessage('success', 'Availability settings saved successfully!');
  })
  .catch(error => {
    console.error('Error saving availability:', error);
    showAvailabilityMessage('danger', 'Error saving availability: ' + error.message);
  })
  .finally(() => {
    // Reset button state
    if (saveAvailabilityBtn) {
      saveAvailabilityBtn.disabled = false;
      saveAvailabilityBtn.innerHTML = originalText;
    }
  });
}

// Function to show availability update messages
function showAvailabilityMessage(type, message) {
  // Find container for the message
  const container = document.querySelector('.availability-section') || 
                   document.querySelector('.card-body') || 
                   document.body;
  
  // Create alert element
  const alertElement = document.createElement('div');
  alertElement.className = `alert alert-${type} mt-2`;
  alertElement.textContent = message;
  
  // Add close button
  const closeButton = document.createElement('button');
  closeButton.type = 'button';
  closeButton.className = 'btn-close';
  closeButton.setAttribute('data-bs-dismiss', 'alert');
  closeButton.setAttribute('aria-label', 'Close');
  alertElement.appendChild(closeButton);
  
  // Add to container
  container.appendChild(alertElement);
  
  // Remove after 3 seconds
  setTimeout(() => alertElement.remove(), 3000);
}

// Function to set up Start Scan button
function setupStartScan() {
  console.log('Setting up start scan button');
  
  const startScanBtn = document.getElementById('startScan') || 
                      document.querySelector('button:contains("Start Scan")');
  
  if (startScanBtn && !startScanBtn.getAttribute('data-handler-attached')) {
    startScanBtn.setAttribute('data-handler-attached', 'true');
    startScanBtn.addEventListener('click', startScan);
  }
}

// Function to start scan
// Function to start scan (consolidated version)
function startScan() {
  console.log('Start scan initiated');
  
  // Get radar elements
  const radarSvg = document.getElementById('radarSvg');
  if (!radarSvg) {
    console.error('Radar SVG not found');
    return;
  }
  
  const userDots = document.getElementById('userDots') || createElementIfNotExists('g', 'userDots', radarSvg);
  const scanCircle = document.getElementById('scanCircle') || createElementIfNotExists('circle', 'scanCircle', radarSvg);
  const scanLine = document.getElementById('scanLine') || createElementIfNotExists('line', 'scanLine', radarSvg);
  const matchesContainer = document.getElementById('matchesContainer');
  const loadingIndicator = document.getElementById('loadingIndicator');
  
  // Clear previous results
  if (userDots) userDots.innerHTML = '';
  if (matchesContainer) {
    matchesContainer.innerHTML = '<div class="col-12 text-center"><p>Scanning for collaborators...</p></div>';
  }
  
  // Show loading indicator
  if (loadingIndicator) loadingIndicator.classList.remove('d-none');
  
  // Animate radar scan
  animateRadarScan();
  
  // Get filter values - handle both Select2 and standard selects
  let selectedSkills = [];
  let selectedInterests = [];
  
  const skillsFilter = document.getElementById('skillsFilter');
  const interestsFilter = document.getElementById('interestsFilter');
  
  // Handle different select implementations
  if (skillsFilter) {
    // Try jQuery Select2 first
    if (window.jQuery && jQuery(skillsFilter).data('select2')) {
      selectedSkills = jQuery(skillsFilter).val() || [];
    } else {
      // Standard select
      selectedSkills = Array.from(skillsFilter.selectedOptions || []).map(option => option.value);
    }
  }
  
  if (interestsFilter) {
    // Try jQuery Select2 first
    if (window.jQuery && jQuery(interestsFilter).data('select2')) {
      selectedInterests = jQuery(interestsFilter).val() || [];
    } else {
      // Standard select
      selectedInterests = Array.from(interestsFilter.selectedOptions || []).map(option => option.value);
    }
  }
  
  const minAvailabilityHours = parseInt(document.getElementById('availabilityFilter')?.value || '0');
  
  // Get CSRF token
  const csrfToken = getCsrfToken();
  if (!csrfToken) {
    console.error('CSRF token not found');
    alert('Error: CSRF token not found. Please refresh the page.');
    return;
  }
  
  // Send fetch request
  fetch('/collab-radar/search/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      skills: selectedSkills,
      interests: selectedInterests,
      min_hours: minAvailabilityHours,
      availability_min: minAvailabilityHours // Include both formats for compatibility
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    console.log('Scan results:', data);
    
    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('d-none');
    }
    
    // Process and display the results
    if (data.users && Array.isArray(data.users)) {
      if (data.users.length > 0) {
        displayRadarResults(data.users, userDots, matchesContainer);
      } else if (matchesContainer) {
        matchesContainer.innerHTML = '<div class="col-12 text-center text-muted"><p>No matching collaborators found</p></div>';
      }
    } else {
      console.error('Invalid response format:', data);
      // Update matches container with error
      if (matchesContainer) {
        matchesContainer.innerHTML = '<div class="col-12 text-center text-danger"><p>Invalid response format</p></div>';
      }
    } 
  })
  .catch(error => {
    console.error('Error fetching collaborators:', error);
    
    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('d-none');
    }
    
    // Show error message
    if (matchesContainer) {
      matchesContainer.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-danger">
            Error scanning for collaborators: ${error.message}
          </div>
        </div>
      `;
    }
    
    // Stop radar animation
    setTimeout(() => {
      if (scanCircle) scanCircle.setAttribute('r', '0');
      if (scanLine) scanLine.setAttribute('transform', 'rotate(0)');
      clearInterval(window.circleInterval);
      clearInterval(window.lineInterval);
    }, 1000);
  });
}

// Function to animate the radar scan
function animateRadarScan() {
  const radarSvg = document.getElementById('radarSvg');
  if (!radarSvg) return;
  
  // Create scan elements if they don't exist
  const scanCircle = document.getElementById('scanCircle') || 
                    createSvgElement('circle', 'scanCircle', radarSvg);
                    
  const scanLine = document.getElementById('scanLine') || 
                  createSvgElement('line', 'scanLine', radarSvg);
  
  if (!scanCircle || !scanLine) return;
  
  // Set initial attributes for circle
  scanCircle.setAttribute('cx', '0');
  scanCircle.setAttribute('cy', '0');
  scanCircle.setAttribute('r', '0');
  scanCircle.setAttribute('fill', 'none');
  scanCircle.setAttribute('stroke', '#10838e');
  scanCircle.setAttribute('stroke-width', '2');
  scanCircle.setAttribute('opacity', '0.5');
  
  // Set initial attributes for line
  scanLine.setAttribute('x1', '0');
  scanLine.setAttribute('y1', '0');
  scanLine.setAttribute('x2', '0');
  scanLine.setAttribute('y2', '-180');
  scanLine.setAttribute('stroke', '#10838e');
  scanLine.setAttribute('stroke-width', '2');
  scanLine.setAttribute('transform', 'rotate(0)');
  
  // Clear any existing animation intervals
  clearInterval(window.circleInterval);
  clearInterval(window.lineInterval);
  
  // Animate circle
  let radius = 0;
  window.circleInterval = setInterval(() => {
    radius += 3;
    scanCircle.setAttribute('r', radius.toString());
    
    if (radius >= 180) {
      clearInterval(window.circleInterval);
      scanCircle.setAttribute('r', '0');
    }
  }, 30);
  
  // Animate line
  let angle = 0;
  window.lineInterval = setInterval(() => {
    angle += 5;
    scanLine.setAttribute('transform', `rotate(${angle})`);
    
    if (angle >= 360) {
      clearInterval(window.lineInterval);
    }
  }, 50);
}

// Helper function to create SVG elements
function createSvgElement(type, id, parent) {
  if (!parent) return null;
  
  const element = document.createElementNS("http://www.w3.org/2000/svg", type);
  element.id = id;
  parent.appendChild(element);
  return element;
}

// Function to display users on the radar
function displayUsers(users) {
  const userDots = document.getElementById('userDots');
  const matchesContainer = document.getElementById('matchesContainer');
  
  if (!userDots || !matchesContainer) return;
  
  // Clear existing dots
  userDots.innerHTML = '';
  
  if (users.length === 0) {
    matchesContainer.innerHTML = '<div class="col-12 text-center text-muted"><p>No matching collaborators found</p></div>';
    return;
  }
  
  // Add user dots to radar
  users.forEach(user => {
    // Calculate position based on match score or use provided coordinates
    const matchScore = user.match_score !== undefined ? user.match_score : 0.5;
    const distance = 180 - (matchScore * 180); // Higher score = closer to center
    const angle = Math.random() * 360; // Random angle
    const x = Math.cos(angle * Math.PI / 180) * distance;
    const y = Math.sin(angle * Math.PI / 180) * distance;
    
    // Create user dot
    const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    dot.setAttribute('cx', user.x || x.toString());
    dot.setAttribute('cy', user.y || y.toString());
    dot.setAttribute('r', '8');
    dot.setAttribute('fill', '#10838e');
    dot.setAttribute('stroke', '#ffffff');
    dot.setAttribute('stroke-width', '2');
    dot.setAttribute('class', 'user-dot');
    
    // Store user data in data attributes
    dot.dataset.userId = user.id;
    dot.dataset.userName = user.name || user.username || `User ${user.id}`;
    dot.dataset.userImage = user.image || user.profile_pic || '';
    dot.dataset.skills = JSON.stringify(user.skills || []);
    dot.dataset.interests = JSON.stringify(user.interests || []);
    dot.dataset.hours = (user.availability_hours || user.availability || 0).toString();
    
    // Add hover effect
    dot.addEventListener('mouseenter', function() {
      this.setAttribute('r', '12');
      this.setAttribute('fill', '#0d6efd');
    });
    
    dot.addEventListener('mouseleave', function() {
      this.setAttribute('r', '8');
      this.setAttribute('fill', '#10838e');
    });
    
    // Add click handler
    dot.addEventListener('click', function() {
      window.location.href = `/profile/${user.username}/`;
    });
    
    userDots.appendChild(dot);
    
    // Add tooltip/label
    const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
    label.setAttribute('x', (parseFloat(dot.getAttribute('cx')) + 12).toString());
    label.setAttribute('y', (parseFloat(dot.getAttribute('cy')) - 8).toString());
    label.setAttribute('font-size', '12');
    label.setAttribute('fill', '#333');
    label.textContent = dot.dataset.userName;
    userDots.appendChild(label);
  });
  
  // Update matches container
  displayMatchCards(users, matchesContainer);
}

// Function to display match cards
function displayMatchCards(users, container) {
  // Clear container
  container.innerHTML = '';
  
  // Create row for grid system
  const row = document.createElement('div');
  row.className = 'row';
  container.appendChild(row);
  
  // Create cards
  users.forEach(user => {
    const userCard = document.createElement('div');
    userCard.className = 'col-md-6 mb-4'; // 2 cards per row on medium screens and up
    
    // Format skills and interests for display
    let skillsHtml = 'No skills';
    if (user.skills && user.skills.length > 0) {
      skillsHtml = '';
      // Handle both array of objects and array of strings
      if (typeof user.skills[0] === 'object') {
        user.skills.forEach(skill => {
          const name = skill.name || skill.skill_name || '';
          const level = skill.proficiency || skill.level || '';
          skillsHtml += `<span class="badge bg-primary me-2 mb-2">${name} ${level ? `(${level})` : ''}</span>`;
        });
      } else {
        skillsHtml = user.skills.map(s => `<span class="badge bg-primary me-2 mb-2">${s}</span>`).join('');
      }
    }
    
    let interestsHtml = 'No interests';
    if (user.interests && user.interests.length > 0) {
      interestsHtml = '';
      // Handle both array of objects and array of strings
      if (typeof user.interests[0] === 'object') {
        user.interests.forEach(interest => {
          const name = interest.name || interest.interest_name || '';
          const level = interest.level || '';
          interestsHtml += `<span class="badge bg-success me-2 mb-2">${name} ${level ? `(${level})` : ''}</span>`;
        });
      } else {
        interestsHtml = user.interests.map(i => `<span class="badge bg-success me-2 mb-2">${i}</span>`).join('');
      }
    }
    
    // Create card HTML
    userCard.innerHTML = `
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light">
          <div class="d-flex align-items-center">
            <img src="${user.profile_pic || user.image || '/static/images/default-profile.png'}" 
                 class="rounded-circle me-3" 
                 style="width: 48px; height: 48px; object-fit: cover;"
                 alt="${user.username || user.name || 'User'}">
            <div>
              <h5 class="mb-0">${user.username || user.name || 'User'}</h5>
              <small class="text-muted">ID: ${user.id}</small>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Skills:</h6>
            <div class="skills-display">${skillsHtml}</div>
          </div>
          <div class="mb-3">
            <h6>Interests:</h6>
            <div class="interests-display">${interestsHtml}</div>
          </div>
          <div>
            <h6>Availability:</h6>
            <div><span class="badge bg-info">${user.availability || 'Less than 5 hours'}</span></div>
          </div>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between">
          <a href="/profile/${user.username}/" class="btn btn-primary btn-sm">View Profile</a>
        </div>
      </div>
    `;
    
    row.appendChild(userCard);
  });
  
  // Set up connect buttons
  setupConnectButtons();
}

// Function to set up connect buttons
function setupConnectButtons() {
  const connectButtons = document.querySelectorAll('.connect-btn');
  
  connectButtons.forEach(button => {
    button.addEventListener('click', function() {
      const userId = this.getAttribute('data-user-id');
      if (userId) {
        // Send connection request or navigate to profile
        sendConnectionRequest(userId);
      }
    });
  });
}

// Function to set up skill and interest buttons
function setupSkillInterestButtons() {
  console.log('Setting up skill and interest buttons');
  
  // Set up add buttons
  const addSkillBtn = document.getElementById('addSkillBtn');
  if (addSkillBtn) {
    addSkillBtn.addEventListener('click', addSkill);
  }
  
  const addInterestBtn = document.getElementById('addInterestBtn');
  if (addInterestBtn) {
    addInterestBtn.addEventListener('click', addInterest);
  }
  
  // Set up remove buttons
  setupRemoveButtons();
}

// Function to set up remove buttons
function setupRemoveButtons() {
  console.log('Setting up remove buttons');
  
  // Handle removing skills
  const skillsContainer = document.querySelector('.skills-container');
  if (skillsContainer) {
    skillsContainer.addEventListener('click', function(event) {
      if (event.target.id && event.target.id.startsWith('remove-skill-')) {
        const skillId = event.target.dataset.skillId;
        console.log('Removing skill:', skillId);
        
        // Create form data
        const formData = new FormData();
        formData.append('skill_id', skillId);
        
        // Get CSRF token
        const csrfToken = getCsrfToken();
        
        // Send fetch request
        fetch('/remove_skill/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          },
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          // Remove the skill badge from the UI
          const badge = event.target.closest('.badge');
          if (badge) {
            badge.remove();
          }
        })
        .catch(error => {
          alert('Error removing skill: ' + error.message);
        });
      }
    });
  }
  
  // Handle removing interests
  const interestsContainer = document.querySelector('.interests-container');
  if (interestsContainer) {
    interestsContainer.addEventListener('click', function(event) {
      if (event.target.id && event.target.id.startsWith('remove-interest-')) {
        const interestId = event.target.dataset.interestId;
        console.log('Removing interest:', interestId);
        
        // Create form data
        const formData = new FormData();
        formData.append('interest_id', interestId);
        
        // Get CSRF token
        const csrfToken = getCsrfToken();
        
        // Send fetch request
        fetch('/remove_interest/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          },
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          // Remove the interest badge from the UI
          const badge = event.target.closest('.badge');
          if (badge) {
            badge.remove();
          }
        })
        .catch(error => {
          alert('Error removing interest: ' + error.message);
        });
      }
    });
  }
}

// Add skill function
function addSkill() {
  console.log('Add skill button clicked');
  const skillName = prompt('Enter skill name:');
  if (!skillName || skillName.trim() === '') return;
  
  const proficiency = prompt('Enter proficiency level (1-3):', '2');
  if (!proficiency || isNaN(parseInt(proficiency))) return;
  
  // Get CSRF token
  const csrfToken = getCookie('csrftoken');
  if (!csrfToken) {
    alert('CSRF token not found. Please refresh the page.');
    return;
  }
  
  // Create request data
  const formData = new FormData();
  formData.append('skill_name', skillName.trim());
  formData.append('proficiency', proficiency);
  
  // Send request
  fetch('/profile/skills/add/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Failed to add skill');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Add skill to UI
      const skillsContainer = document.querySelector('.skills-container');
      if (!skillsContainer) {
        // Try alternative selector based on your UI structure
        const skillsSection = document.querySelector('#skills') || document.querySelector('div:has(> h2:contains("SKILLS"))');
        if (skillsSection) {
          skillsContainer = skillsSection.querySelector('div') || skillsSection;
        }
      }
      
      if (skillsContainer) {
        const skillBadge = document.createElement('span');
        skillBadge.className = 'badge bg-primary me-2 mb-2';
        
        // Create text node for the badge content
        const badgeText = document.createTextNode(`${skillName} (${proficiency}) `);
        skillBadge.appendChild(badgeText);
        
        // Create the close button
        const closeButton = document.createElement('button');
        closeButton.className = 'btn-close btn-close-white ms-1';
        closeButton.setAttribute('aria-label', 'Remove');
        closeButton.setAttribute('data-skill-id', data.skill_id);
        
        // Add event listener directly to the button
        closeButton.addEventListener('click', function() {
          removeSkill(data.skill_id);
        });
        
        skillBadge.appendChild(closeButton);
        skillsContainer.appendChild(skillBadge);
        
        console.log('Skill added successfully to UI');
      } else {
        console.warn('Skills container not found, reload may be required');
        location.reload();
      }
    } else {
      alert('Failed to add skill: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error adding skill:', error);
    alert('An error occurred while adding the skill');
  });
}

// Function to remove a skill
function removeSkill(skillId) {
  if (!skillId) return;
  
  const csrfToken = getCookie('csrftoken');
  if (!csrfToken) {
    alert('CSRF token not found. Please refresh the page.');
    return;
  }
  
  fetch(`/profile/skills/remove/${skillId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Failed to remove skill');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Remove the skill badge from the UI
      const skillButton = document.querySelector(`button[data-skill-id="${skillId}"]`);
      if (skillButton) {
        const skillBadge = skillButton.closest('.badge');
        if (skillBadge) {
          skillBadge.remove();
        }
      }
    } else {
      alert('Failed to remove skill: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error removing skill:', error);
    alert('An error occurred while removing the skill');
  });
}

// Add interest function
function addInterest() {
  console.log('Add interest button clicked');
  const interestName = prompt('Enter interest name:');
  if (!interestName || interestName.trim() === '') return;
  
  const interestLevel = prompt('Enter interest level (1-3):', '2');
  if (!interestLevel || isNaN(parseInt(interestLevel))) return;
  
  // Get CSRF token
  const csrfToken = getCookie('csrftoken');
  if (!csrfToken) {
    alert('CSRF token not found. Please refresh the page.');
    return;
  }
  
  // Create request data
  const formData = new FormData();
  formData.append('interest_name', interestName.trim());
  formData.append('interest_level', interestLevel);
  
  // Send request
  fetch('/profile/interests/add/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Failed to add interest');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Add interest to UI
      const interestsContainer = document.querySelector('.interests-container');
      if (!interestsContainer) {
        // Try alternative selector based on your UI structure
        const interestsSection = document.querySelector('#interests') || document.querySelector('div:has(> h2:contains("PROJECT INTERESTS"))');
        if (interestsSection) {
          interestsContainer = interestsSection.querySelector('div') || interestsSection;
        }
      }
      
      if (interestsContainer) {
        // Determine display text based on interest level
        let levelText = '(Interested)';
        if (interestLevel == 3) {
          levelText = '(Very Interested)';
        } else if (interestLevel == 1) {
          levelText = '(Somewhat Interested)';
        }
        
        // Determine background color based on interest level
        let bgClass = 'bg-success';
        if (interestLevel == 3) {
          bgClass = 'bg-info';
        } else if (interestLevel == 1) {
          bgClass = 'bg-secondary';
        }
        
        const interestBadge = document.createElement('span');
        interestBadge.className = `badge ${bgClass} me-2 mb-2`;
        
        // Create text node for the badge content
        const badgeText = document.createTextNode(`${interestName} ${levelText} `);
        interestBadge.appendChild(badgeText);
        
        // Create the close button
        const closeButton = document.createElement('button');
        closeButton.className = 'btn-close btn-close-white ms-1';
        closeButton.setAttribute('aria-label', 'Remove');
        closeButton.setAttribute('data-interest-id', data.interest_id);
        
        // Add event listener directly to the button
        closeButton.addEventListener('click', function() {
          removeInterest(data.interest_id);
        });
        
        interestBadge.appendChild(closeButton);
        interestsContainer.appendChild(interestBadge);
        
        console.log('Interest added successfully to UI');
      } else {
        console.warn('Interests container not found, reload may be required');
        location.reload();
      }
    } else {
      alert('Failed to add interest: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error adding interest:', error);
    alert('An error occurred while adding the interest');
  });
}

// Function to remove an interest
function removeInterest(interestId) {
  if (!interestId) return;
  
  const csrfToken = getCookie('csrftoken');
  if (!csrfToken) {
    alert('CSRF token not found. Please refresh the page.');
    return;
  }
  
  fetch(`/profile/interests/remove/${interestId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Failed to remove interest');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Remove the interest badge from the UI
      const interestButton = document.querySelector(`button[data-interest-id="${interestId}"]`);
      if (interestButton) {
        const interestBadge = interestButton.closest('.badge');
        if (interestBadge) {
          interestBadge.remove();
        }
      }
    } else {
      alert('Failed to remove interest: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error removing interest:', error);
    alert('An error occurred while removing the interest');
  });
}

// Helper function to get cookie value (for CSRF)
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

// Helper function to get cookie value (for CSRF)
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}


// Display radar results
// Function to display users on the radar
function displayRadarResults(users, userDots, matchesContainer) {
  // Clear existing dots
  userDots.innerHTML = '';
  
  // Set up SVG namespace
  const svgNS = "http://www.w3.org/2000/svg";
  
  // Add user dots to radar
  users.forEach(user => {
    // Calculate position based on match score if not provided
    const x = user.x || (Math.cos(Math.random() * 2 * Math.PI) * 120);
    const y = user.y || (Math.sin(Math.random() * 2 * Math.PI) * 120);
    
    // Create user dot
    const dot = document.createElementNS(svgNS, "circle");
    dot.setAttribute("cx", x);
    dot.setAttribute("cy", y);
    dot.setAttribute("r", "8");
    dot.setAttribute("fill", "#5045e6");
    dot.setAttribute("stroke", "#ffffff");
    dot.setAttribute("stroke-width", "2");
    dot.setAttribute("opacity", "0.8");
    dot.classList.add("user-dot");
    
    // Store user data in data attributes
    dot.dataset.userId = user.username;
    dot.dataset.userName = user.username || user.name || `User ${user.username}`;
    dot.dataset.userImage = user.profile_pic || user.image || '/static/images/default-profile.png';
    dot.dataset.skills = JSON.stringify(user.skills || []);
    dot.dataset.interests = JSON.stringify(user.interests || []);
    dot.dataset.hours = (user.availability_hours || user.availability || 0).toString();
    
    // Add event listeners
    dot.addEventListener('mouseenter', function() {
      this.setAttribute('r', '12');
      this.setAttribute('fill', '#0d6efd');
    });
    
    dot.addEventListener('mouseleave', function() {
      this.setAttribute('r', '8');
      this.setAttribute('fill', '#5045e6');
    });
    
    dot.addEventListener('click', function() {
      window.location.href = `/profile/${this.dataset.userId}/`;
    });
    
    userDots.appendChild(dot);
    
    // Add username label
    const label = document.createElementNS(svgNS, "text");
    label.setAttribute("x", x);
    label.setAttribute("y", y - 15);
    label.setAttribute("text-anchor", "middle");
    label.setAttribute("font-size", "12");
    label.setAttribute("fill", "#333333");
    label.textContent = dot.dataset.userName;
    userDots.appendChild(label);
  });
  
  // Display match cards
  displayMatchCards(users, matchesContainer);
}

// Add CSS styling for cards
function addCardStyles() {
  if (document.getElementById('card-display-styles')) return;
  
  const styleEl = document.createElement('style');
  styleEl.id = 'card-display-styles';
  styleEl.textContent = `
    #matchesContainer {
      width: 100%;
      max-width: 100%;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
    }
    
    #matchesContainer .col-md-6,
    #matchesContainer .col-lg-4 {
      display: flex;
      padding: 0.5rem;
    }
    
    .card {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: visible;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .card-body {
      flex: 1;
      padding: 1rem;
      overflow: hidden;
    }
    
    .user-details {
      width: 100%;
    }
    
    .skills-container,
    .interests-container {
      display: flex;
      flex-wrap: wrap;
      margin-top: 0.25rem;
    }
    
    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 16px;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      display: inline-block;
      white-space: nowrap;
    }
    
    .rounded-circle {
      border: 2px solid #eee;
      object-fit: cover;
    }
  `;
  document.head.appendChild(styleEl);
}


// Event handlers for connect buttons
function attachConnectListeners() {
  document.querySelectorAll('.connect-btn').forEach(button => {
    button.addEventListener('click', function() {
      const username = this.getAttribute('data-username');
      if (username) {
        window.location.href = `/profile/${username}/`;
      }
    });
  });
}

// Utility function to create DOM elements if they don't exist
function createElementIfNotExists(elementType, id, parent) {
  let element = document.getElementById(id);
  if (!element && parent) {
    if (['g', 'circle', 'line', 'path', 'text', 'rect'].includes(elementType)) {
      element = document.createElementNS("http://www.w3.org/2000/svg", elementType);
    } else {
      element = document.createElement(elementType);
    }
    element.id = id;
    parent.appendChild(element);
  }
  return element;
}

// Helper function to get selected values from a select element
function getSelectedValues(selectId) {
  const selectElement = document.getElementById(selectId);
  if (!selectElement) return [];
  
  // Handle both native select and Select2 plugin
  if (selectElement.selectedOptions) {
    return Array.from(selectElement.selectedOptions).map(o => o.value);
  } else if ($(selectElement).data('select2')) {
    return $(selectElement).val() || [];
  }
  
  return [];
}

// Radar animation management
let radarInterval;

function startRadarAnimation(scanLine, scanCircle) {
  let rotation = 0;
  let totalRotation = 0;
  let pulseCount = 0;

  scanLine.setAttribute("transform", `rotate(0)`);
  scanCircle.setAttribute("r", "0");

  clearInterval(radarInterval);
  radarInterval = setInterval(() => {
    // Update rotation
    rotation += 3;
    totalRotation += 3;
    scanLine.setAttribute("transform", `rotate(${rotation})`);

    // Update scan circle radius
    let currentRadius = parseFloat(scanCircle.getAttribute("r"));
    let newRadius = currentRadius + 4;
    if (newRadius > 180) {
      newRadius = 0;
      pulseCount++;
    }
    scanCircle.setAttribute("r", newRadius);

    // Stop after 3 full rotations and 2 circle pulses
    if (totalRotation >= 1080 && pulseCount >= 2) {
      clearInterval(radarInterval);
    }
  }, 30);
}

function stopRadarAnimation() {
  clearInterval(radarInterval);
  const scanCircle = document.getElementById('scanCircle');
  const scanLine = document.getElementById('scanLine');
  if (scanCircle) scanCircle.setAttribute("r", "0");
  if (scanLine) scanLine.setAttribute("transform", "rotate(0)");
}



// Availability management functions
function saveAvailability() {
  console.log('Executing save availability function');
  
  // Find availability toggle
  let available = false;
  const availableToggle = document.querySelector('input[type="checkbox"]');
  
  if (availableToggle) {
    available = availableToggle.checked;
  }
  
  // Find hours select
  let hours = 5; // Default
  const hoursSelect = document.querySelector('select[id^="hours"], select[id*="hours"], select[id="availabilityHours"]');
  
  if (hoursSelect) {
    hours = hoursSelect.value;
  } else {
    // Try to find another way - maybe a dropdown with hours text
    const hoursDropdown = document.querySelector('select:not([id="skillsFilter"]):not([id="interestsFilter"]):not([id="availabilityFilter"])');
    if (hoursDropdown) {
      hours = hoursDropdown.value;
      // Extract numeric value if it's text like "more than 20 hours/week"
      if (typeof hours === 'string' && hours.includes('hours')) {
        const match = hours.match(/\d+/);
        if (match) {
          hours = match[0];
        }
      }
    }
  }
  
  // Find notes field
  let notes = '';
  const notesField = document.querySelector('textarea');
  
  if (notesField) {
    notes = notesField.value;
  }
  
  console.log('Form values:', { available, hours, notes });

  // Get CSRF token
  const csrfToken = getCsrfToken();
  
  if (!csrfToken) {
    console.error('CSRF token not found');
    showMessage('Error: CSRF token not found. Please refresh the page.', 'error');
    return;
  }
  
  // Find save button
  const saveBtn = findSaveButton();
  if (!saveBtn) {
    console.error('Save button not found');
    showMessage('Could not find the save button. Please try again.', 'error');
    return;
  }
  
  // Add visual feedback
  const originalText = saveBtn.textContent;
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  // Use form data instead of JSON to match Django's expectation
  const endpoint = '/profile/availability/';
  
  fetch(endpoint, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      available: available.toString(),
      hours: hours.toString(),
      notes: notes || ''
    })
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => {
        throw new Error(`Server error (${response.status}): ${text}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    
    // Reset button state
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    
    if (data.success) {
      showMessage('Availability updated successfully!', 'success');
    } else {
      showMessage('Failed to update availability: ' + (data.error || 'Unknown error'), 'error');
    }
  })
  .catch(error => {
    console.error('Error updating availability:', error);
    
    // Reset button state
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    
    // Show error message
    showMessage('An error occurred while updating availability: ' + error.message, 'error');
  });
}

// Helper function to find save button
function findSaveButton() {
  let saveBtn = document.getElementById('saveAvailability');
  
  if (!saveBtn) {
    // Try by text content
    saveBtn = Array.from(document.querySelectorAll('button')).find(
      btn => btn.textContent.trim() === 'Save Availability'
    );
  }
  
  if (!saveBtn) {
    // Try by class
    saveBtn = document.querySelector('.btn-primary');
  }
  
  return saveBtn;
}

// Setup save availability button
function setupSaveAvailability() {
  const saveAvailabilityBtn = findSaveButton();
  
  if (saveAvailabilityBtn) {
    saveAvailabilityBtn.id = 'saveAvailability';
    
    // Use a safer way to remove old event listeners
    const newBtn = saveAvailabilityBtn.cloneNode(true);
    saveAvailabilityBtn.parentNode.replaceChild(newBtn, saveAvailabilityBtn);
    
    // Add the click handler
    newBtn.addEventListener('click', function(e) {
      e.preventDefault();
      saveAvailability();
    });
  }
}

// Display message helper
function showMessage(message, type = 'info') {
  // Remove any existing messages
  document.querySelectorAll('.alert').forEach(el => el.remove());
  
  // Create message element
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} mt-2`;
  alertDiv.textContent = message;
  
  // Find container
  const saveBtn = findSaveButton();
  const container = document.querySelector('.availability-section') || 
                   (saveBtn ? saveBtn.closest('.card-body') : null) || 
                   document.body;
  
  // Add message to container
  container.appendChild(alertDiv);
  
  // Remove message after 3 seconds
  setTimeout(() => {
    alertDiv.remove();
  }, 3000);
}

// Skills and interests management
function setupSkillsAndInterests() {
  if (typeof $ !== 'undefined' && $.fn.select2) {
    // Initialize the select2 plugin for multiple selection dropdowns
    $('#skillsFilter, #interestsFilter').select2({
      theme: 'bootstrap-5',
      width: '100%',
      closeOnSelect: false,
      allowClear: true
    });
    
    // Handle filter changes
    $('#skillsFilter, #interestsFilter, #availabilityFilter').on('change', function() {
      applyFilters();
    });
    
    // Initialize new skill/interest addition functionality
    setupCustomTagAddition();
  }
  
  // Setup remove buttons for skills and interests
  setupRemoveButtons();
}

// Apply filters to collaborators
function applyFilters() {
  const selectedSkills = getSelectedValues('skillsFilter');
  const selectedInterests = getSelectedValues('interestsFilter');
  const minAvailability = document.getElementById('availabilityFilter')?.value || 0;
  
  console.log('Filtering with:', {
    skills: selectedSkills,
    interests: selectedInterests,
    minAvailability: minAvailability
  });
  
  // Find visible collaborators based on filters
  const collaborators = document.querySelectorAll('.collaborator-point');
  collaborators.forEach(collaborator => {
    const userSkills = JSON.parse(collaborator.dataset.skills || '[]');
    const userInterests = JSON.parse(collaborator.dataset.interests || '[]');
    const userAvailability = parseInt(collaborator.dataset.availability || '0');
    
    // Check if user meets all filter criteria
    const matchesSkills = selectedSkills.length === 0 || 
                          selectedSkills.some(skillId => userSkills.includes(parseInt(skillId)));
    const matchesInterests = selectedInterests.length === 0 || 
                            selectedInterests.some(interestId => userInterests.includes(parseInt(interestId)));
    const meetsAvailability = userAvailability >= parseInt(minAvailability);
    
    // Show/hide based on filter matches
    collaborator.style.display = matchesSkills && matchesInterests && meetsAvailability ? 'block' : 'none';
  });
  
  // Update the radar visualization
  updateRadarDisplay();
}

// Function to set up custom tag addition
function setupCustomTagAddition() {
  if (typeof $ === 'undefined' || !$.fn.select2) return;
  
  $('#skillsFilter').select2({
    tags: true,
    createTag: function(params) {
      return {
        id: 'new:' + params.term,
        text: params.term + ' (new)',
        newTag: true
      };
    }
  }).on('select2:select', function(e) {
    if (e.params.data.newTag) {
      const skillName = e.params.data.text.replace(' (new)', '');
      saveNewSkill(skillName);
    }
  });
  
  $('#interestsFilter').select2({
    tags: true,
    createTag: function(params) {
      return {
        id: 'new:' + params.term,
        text: params.term + ' (new)',
        newTag: true
      };
    }
  }).on('select2:select', function(e) {
    if (e.params.data.newTag) {
      const interestName = e.params.data.text.replace(' (new)', '');
      saveNewInterest(interestName);
    }
  });
}

// Function to save new skill to database
function saveNewSkill(skillName) {
  fetch('/api/skills', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ name: skillName })
  })
  .then(response => response.json())
  .then(data => {
    console.log('Skill added:', data);
    // Implementation to update the skill option would go here
  })
  .catch(error => {
    console.error('Error adding skill:', error);
  });
}

// Function to save new interest to database
function saveNewInterest(interestName) {
  fetch('/api/interests', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ name: interestName })
  })
  .then(response => response.json())
  .then(data => {
    console.log('Interest added:', data);
    // Implementation to update the interest option would go here
  })
  .catch(error => {
    console.error('Error adding interest:', error);
  });
}

// Update the radar visualization
function updateRadarDisplay() {
  console.log('Updating radar display with filtered users');
  
  // Redraw or update radar based on visible collaborators
  const visibleCollaborators = document.querySelectorAll('.collaborator-point:not([style*="display: none"])');
  
  // Implementation for radar chart update
  if (window.radarChart) {
    window.radarChart.update({
      series: [{
        data: Array.from(visibleCollaborators).map(c => ({
          name: c.dataset.name,
          x: parseFloat(c.dataset.x),
          y: parseFloat(c.dataset.y)
        }))
      }]
    });
  }
}

// Setup remove buttons for skills and interests
function setupRemoveButtons() {
  document.querySelectorAll('[id^="remove-skill-"]').forEach(button => {
    button.addEventListener('click', function() {
      const skillId = this.getAttribute('data-skill-id');
      if (skillId) {
        removeSkill(skillId);
      }
    });
  });
  
  document.querySelectorAll('[id^="remove-interest-"]').forEach(button => {
    button.addEventListener('click', function() {
      const interestId = this.getAttribute('data-interest-id');
      if (interestId) {
        removeInterest(interestId);
      }
    });
  });
}

// Remove skill function
function removeSkill(skillId) {
  fetch(`/profile/skills/remove/${skillId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/x-www-form-urlencoded',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Remove the skill item from UI
      const skillElement = document.querySelector(`[data-skill-id="${skillId}"]`)?.closest('.badge');
      if (skillElement) {
        skillElement.remove();
      } else {
        location.reload();
      }
    } else {
      showMessage('Failed to remove skill', 'error');
    }
  })
  .catch(error => {
    console.error('Error removing skill:', error);
    showMessage('An error occurred while removing the skill', 'error');
  });
}

// Remove interest function
function removeInterest(interestId) {
  fetch(`/profile/interests/remove/${interestId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCsrfToken(),
      'Content-Type': 'application/x-www-form-urlencoded',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Remove the interest item from UI
      const interestElement = document.querySelector(`[data-interest-id="${interestId}"]`)?.closest('.badge');
      if (interestElement) {
        interestElement.remove();
      } else {
        location.reload();
      }
    } else {
      showMessage('Failed to remove interest', 'error');
    }
  })
  .catch(error => {
    console.error('Error removing interest:', error);
    showMessage('An error occurred while removing the interest', 'error');
  });
}

// Initialize all functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Add styles
  addCardStyles();
  
  // Initialize container
  const matchesContainer = document.getElementById('matchesContainer');
  if (matchesContainer) {
    matchesContainer.className = 'row g-3';
  }
  
  // Set up availability form
  const availForm = document.querySelector('form');
  if (availForm) {
    // Prevent default form submission
    availForm.addEventListener('submit', function(e) {
      e.preventDefault();
      saveAvailability();
      return false;
    });
  }
  
  // Setup save button
  setupSaveAvailability();
  
  // Initialize skills and interests functionality
  setupSkillsAndInterests();
  
  // Add click listener to scan button if it exists
  const scanButton = document.getElementById('scanButton');
  if (scanButton) {
    scanButton.addEventListener('click', startScan);
  }
  
  // Attach listeners to any existing connect buttons
  attachConnectListeners();
  
  // Apply filters initially
  if (document.getElementById('skillsFilter') || 
      document.getElementById('interestsFilter') || 
      document.getElementById('availabilityFilter')) {
    applyFilters();
  }
});
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Then load Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="collab-radar-container">
  <div class="d-flex flex-column">
    <!-- Skills & Interests Panel - Top fixed width sidebar -->
    <div class="collab-sidebar mb-4" style="width: 100%; flex-shrink: 0;">
      <div class="card profile-card">
        <div class="card-header text-white" style="background-color: #10838EFD;">
          <h5 class="mb-0">Your Collab Profile</h5>
        </div>
        <div class="card-body" style="background-color: #fef2f9;">
          <div class="mb-4">
            <h6 class="sidebar-section-title">SKILLS</h6>
            <div class="d-flex flex-wrap gap-2 mb-2 skills-container">
              {% for user_skill in user_skills %}
                <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                  {{ user_skill.skill.name }} ({{ user_skill.get_proficiency_level_display }})
                  <button class="btn-close btn-close-sm ms-1" id="remove-skill-{{ user_skill.skill.id }}" data-skill-id="{{ user_skill.skill.id }}"></button>
                </span>
              {% empty %}
                <p class="text-muted small">No skills added yet</p>
              {% endfor %}
            </div>
            <button id="add-skill-btn" class="btn btn-sm custom-hover-button" onclick="addSkill()">Add</button>
          </div>
          
          <div class="mb-4">
            <h6 class="sidebar-section-title">PROJECT INTERESTS</h6>
            <div class="d-flex flex-wrap gap-2 mb-2 interests-container">
              {% for user_interest in user_interests %}
                <span class="badge bg-success-subtle text-success border border-success-subtle">
                  {{ user_interest.project_interest.name }} ({{ user_interest.get_interest_level_display }})
                  <button class="btn-close btn-close-sm ms-1" id="remove-interest-{{ user_interest.project_interest.id }}" data-interest-id="{{ user_interest.project_interest.id }}"></button>
                </span>
              {% empty %}
                <p class="text-muted small">No project interests added yet</p>
              {% endfor %}
            </div>
            <button id="add-interest-btn" class="btn btn-sm custom-hover-button" onclick="addInterest()">Add</button>
          </div>
          <div>
            <h6 class="sidebar-section-title">AVAILABILITY</h6>
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="availableToggle" {% if user_availability.available_for_collab %}checked{% endif %}>
              <label class="form-check-label" for="availableToggle">Available for Collaboration</label>
            </div>
            
            <div class="mb-3">
              <label for="availabilityHours" class="form-label small">Hours per week</label>
              <select class="form-select form-select-sm" id="availabilityHours">
                <option value="5" {% if user_availability.availability_hours == 5 %}selected{% endif %}>5 hours/week</option>
                <option value="10" {% if user_availability.availability_hours == 10 %}selected{% endif %}>5-10 hours/week</option>
                <option value="20" {% if user_availability.availability_hours == 20 %}selected{% endif %}>10-20 hours/week</option>
                <option value="40" {% if user_availability.availability_hours == 40 %}selected{% endif %}>more than 20 hours/week</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="availabilityNotes" class="form-label small">Notes (optional)</label>
              <textarea class="form-control form-control-sm" id="availabilityNotes" rows="2">{{ user_availability.notes }}</textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Collab Radar Panel -->
    <div class="radar-main-content flex-grow-1">
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <!-- Header -->
            <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #10838EFD;">
              <h5 class="mb-0">Find Collaborators</h5>
              <button id="startScan" class="btn btn-sm btn-light">Start Scan</button>
            </div>

            <!-- Filters and Radar -->
            <div class="card-body" style="background-color: #fef2f9;">
              <!-- Filters -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">Filter by Skills</label>
                  <select class="form-select" id="skillsFilter" multiple data-placeholder="Select skills...">
                    {% for skill in top_skills %}
                      <option value="{{ skill.id }}">{{ skill.name }} ({{ skill.user_count }})</option>
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Type to search or add new skills</small>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Filter by Interests</label>
                  <select class="form-select" id="interestsFilter" multiple data-placeholder="Select interests...">
                    {% for interest in top_interests %}
                      <option value="{{ interest.id }}">{{ interest.name }} ({{ interest.user_count }})</option>
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Type to search or add new interests</small>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Min. Availability</label>
                  <select class="form-select" id="availabilityFilter">
                    <option value="0">Any</option>
                    <option value="5">At least 5 hours/week</option>
                    <option value="10">At least 10 hours/week</option>
                    <option value="20">At least 20 hours/week</option>
                  </select>
                </div>
              </div>

              <!-- Radar Display -->
              <div class="radar-container position-relative mb-4" style="height: 400px;">
                <!-- SVG Radar -->
                <svg id="radarSvg" width="100%" height="100%" viewBox="-200 -200 400 400" class="radar-svg">
                  <!-- Radar Circles -->
                  <circle cx="0" cy="0" r="180" fill="none" stroke="#aaf0c9" stroke-width="1" />
                  <circle cx="0" cy="0" r="120" fill="none" stroke="#aaf0c9" stroke-width="1" />
                  <circle cx="0" cy="0" r="60" fill="none" stroke="#aaf0c9" stroke-width="1" />

                  <!-- Radar Lines -->
                  <line x1="-180" y1="0" x2="180" y2="0" stroke="#aaf0c9" stroke-width="1" />
                  <line x1="0" y1="-180" x2="0" y2="180" stroke="#aaf0c9" stroke-width="1" />
                  <line x1="-127.28" y1="-127.28" x2="127.28" y2="127.28" stroke="#aaf0c9" stroke-width="1" />
                  <line x1="127.28" y1="-127.28" x2="-127.28" y2="127.28" stroke="#aaf0c9" stroke-width="1" />

                  <!-- Center Dot -->
                  <circle cx="0" cy="0" r="5" fill="#5045e6" />

                  <!-- User Dots Group -->
                  <g id="userDots"></g>

                  <!-- Scan Animation -->
                  <circle id="scanCircle" cx="0" cy="0" r="0" fill="none" stroke="#5045e6" stroke-width="2" opacity="0.5" />
                  <line id="scanLine" x1="0" y1="0" x2="0" y2="-180" stroke="#5045e6" stroke-width="2" opacity="0.7" transform="rotate(0)" />
                </svg>

                <!-- Loading Spinner -->
                <div id="loadingIndicator" class="position-absolute top-50 start-50 translate-middle d-none">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>

              <!-- Collaborator Matches Section -->
              <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #10838EFD;">
                  <h5 class="mb-0">COLLABORATOR MATCHES</h5>
                </div>
                <div class="card-body p-4">
                  <div id="matchesContainer" class="row gx-4 gy-4">
                    <!-- Initially show loading or empty state message -->
                    <div class="col-12 text-center text-muted">
                      <p>Click "Start Scan" to find potential collaborators</p>
                    </div>
                    
                    <!-- Match cards will be dynamically inserted here by JavaScript -->
                  </div>
                </div>
              </div>
              <!-- End Collaborator Matches -->

            </div> <!-- End card-body -->
          </div> <!-- End card -->
        </div> <!-- End col-12 -->
      </div> <!-- End row -->
    </div> <!-- End radar-main-content -->
  </div>
</div>

<style>
  /* General styles */
  .collab-radar-container {
    background-color: #ffffff;
    padding: 20px;
  }
  
  /* Profile card with pink background */
  .profile-card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  /* Button Styles */
  .custom-hover-button {
    color: #10838e;
    border: 1px solid #10838e;
    background-color: transparent;
    transition: background-color 0.3s ease;
  }
  
  .custom-hover-button:hover {
    background-color: #b7e9e9;
    color: #10838e;
    border-color: #10838e;
  }
  
  /* Form elements customization */
  .form-check-input:checked {
    background-color: #10838e;
    border-color: #10838e;
  }
  
  .form-check-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(16, 131, 142, 0.25);
  }
  
  /* Match card styling */
  #matchesContainer .col-12 {
    padding: 10px;
  }
  
  .availability-badge {
    min-height: 40px;
    display: flex;
    align-items: center;
  }
  
  .availability-badge .badge {
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.85rem;
  }
  
  .match-card {
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .match-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  #matchesContainer .col-md-6 {
    margin-bottom: 1rem;
    display: flex;
  }
  
  #matchesContainer .text-center.text-muted {
    width: 100%;
    padding: 2rem 0;
  }
  
  /* Responsive layout */
  @media (max-width: 768px) {
    .match-card {
      width: 100%;
      margin-right: 0;
    }
  }
  
  /* User details styling */
  .user-details {
    font-size: 0.9rem;
  }
  
  .custom-hover-text {
    background-color: #10838efd;
    color: transparent;
    border: none;
  }
  
  .custom-hover-text:hover {
    color: #f0d1e5;
  }
  
  .detail-row {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  
  .detail-label {
    min-width: 80px;
    margin-right: 0.5rem;
  }
  
  .detail-content {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  
  #matchesContainer .card {
    width: 100%;
  }
  
  #matchesContainer .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  /* Section titles */
  .sidebar-section-title {
    color: #333;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
  }
</style>
{% endblock %}